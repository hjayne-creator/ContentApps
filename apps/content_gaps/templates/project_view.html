{% extends 'base.html' %}
{% block title %}Project Dashboard | Content Gaps{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
        <a href="{{ url_for('content_gaps.index') }}" class="text-green-600 hover:underline">&larr; Back to Projects</a>
        <h1 class="text-2xl font-bold text-green-700">{{ project.project_name if project else 'Project Dashboard' }}</h1>
    </div>

    <!-- Main Content -->
    <div class="space-y-8">
        <!-- Topic Trees Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-green-800">Topic Trees</h2>
                <a href="{{ url_for('content_gaps.create_topic_tree', project_id=project_id) }}" 
                   class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                    + New Topic Tree
                </a>
            </div>
            {% if topic_trees and topic_trees|length > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for tree in topic_trees %}
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex flex-col h-full">
                            <div class="flex-grow">
                                <div class="font-bold text-green-700">{{ tree.tree_name }}</div>
                                <div class="text-sm text-gray-500">Root Topic: {{ tree.root_topic }}</div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <a href="{{ url_for('content_gaps.edit_topic_tree_vertical', project_id=project_id, tree_id=tree.tree_id) }}" 
                                   class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Edit</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-gray-500">No topic trees found. Click "+ New Topic Tree" to get started.</div>
            {% endif %}
        </div>

        <!-- Sites Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-green-800">Sites</h2>
                <a href="{{ url_for('content_gaps.upload_site_content', project_id=project_id) }}" 
                   class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                    + Upload Site Content
                </a>
            </div>
            {% if sites and sites|length > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for site in sites %}
                    <div class="border rounded-lg p-4 hover:bg-gray-50 relative group">
                        <div class="flex flex-col h-full">
                            <div class="flex-grow">
                                <div class="font-bold text-green-700">{{ site.label }}</div>
                                <div class="text-sm text-gray-500">Pages: {{ site.pages|length }}</div>
                                {% if site.is_my_site %}
                                    <span class="inline-block bg-green-100 text-green-700 text-xs px-2 py-1 rounded mt-1">My Site</span>
                                {% endif %}
                            </div>
                            <button 
                                onclick="deleteSite('{{ site.site_id }}')"
                                class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                                title="Delete site">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-gray-500">No sites uploaded. Click "+ Upload Site Content" to add your first site.</div>
            {% endif %}
        </div>

        <!-- Run Analysis Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-green-800 mb-4">Run Analysis</h2>
            <form method="post" action="{{ url_for('content_gaps.run_topic_matching', project_id=project_id) }}" 
                  class="max-w-2xl mx-auto space-y-6" id="matchingForm">
                <div>
                    <label for="topic_tree_id" class="block text-sm font-medium text-gray-700 mb-1">Select Topic Tree</label>
                    <select name="topic_tree_id" id="topic_tree_id" 
                            class="form-select w-full border border-gray-300 rounded px-3 py-2">
                        {% for tree in topic_trees %}
                            <option value="{{ tree.tree_id }}">{{ tree.tree_name }} ({{ tree.root_topic }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Sites</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for site in sites %}
                        <div class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                            <input type="checkbox" name="site_ids[]" value="{{ site.site_id }}" 
                                   class="h-4 w-4 text-green-600 border-gray-300 rounded">
                            <label class="ml-3 text-sm text-gray-700">{{ site.label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" 
                        class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" 
                        id="runMatchingBtn">
                    Run Analysis
                </button>
            </form>
            <div id="taskStatus" class="hidden mt-4 p-4 rounded">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div>
                    <span class="text-gray-700">Processing analysis...</span>
                </div>
            </div>
        </div>

        <!-- Analysis Jobs Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-green-800 mb-4">Job Runs</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Id</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Jobs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const matchingForm = document.getElementById('matchingForm');
    const taskStatus = document.getElementById('taskStatus');
    const runMatchingBtn = document.getElementById('runMatchingBtn');
    const jobsTableBody = document.getElementById('jobsTableBody');
    let statusCheckInterval;

    // Helper function to get status class
    function getStatusClass(status) {
        switch(status) {
            case 'COMPLETED':
                return 'bg-green-100 text-green-800';
            case 'RUNNING':
                return 'bg-blue-100 text-blue-800';
            case 'FAILED':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // Function to update jobs table
    function updateJobsTable() {
        fetch(`{{ url_for('content_gaps.task_status', project_id=project_id) }}`)
            .then(response => response.json())
            .then(data => {
                jobsTableBody.innerHTML = '';
                
                // Sort jobs by creation time, newest first
                const jobs = data.jobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                jobs.forEach(job => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${job.job_id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${getStatusClass(job.status)}">
                                ${job.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(job.created_at).toLocaleString(undefined, {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZoneName: 'short'
                            })}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${job.status === 'COMPLETED' ? 
                                `<a href="${job.compare_url}" class="text-indigo-600 hover:text-indigo-900">View Report</a>` : 
                                ''}
                        </td>
                    `;
                    jobsTableBody.appendChild(row);
                });

                // Update current task status if running
                if (data.status === 'RUNNING') {
                    taskStatus.classList.remove('hidden');
                    taskStatus.innerHTML = `
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div>
                            <span class="text-gray-700">Processing analysis...</span>
                        </div>
                    `;
                    runMatchingBtn.disabled = true;
                    runMatchingBtn.classList.add('opacity-50');
                } else if (data.status === 'COMPLETED' && jobs.length > 0 && jobs[0].status === 'COMPLETED') {
                    // Check if the job was completed within the last 30 seconds
                    const jobCompletionTime = new Date(jobs[0].created_at);
                    const now = new Date();
                    const timeSinceCompletion = (now - jobCompletionTime) / 1000; // Convert to seconds
                    
                    if (timeSinceCompletion <= 30) {
                        // Only show completion message if job was completed recently
                        taskStatus.classList.remove('hidden');
                        taskStatus.innerHTML = '<div class="text-green-600">Analysis completed successfully!</div>';
                    } else {
                        // Hide status message if job is older than 30 seconds
                        taskStatus.classList.add('hidden');
                    }
                    runMatchingBtn.disabled = false;
                    runMatchingBtn.classList.remove('opacity-50');
                } else if (data.status === 'FAILED') {
                    taskStatus.classList.remove('hidden');
                    taskStatus.innerHTML = `<div class="text-red-600">Analysis failed: ${data.error_message || 'Unknown error'}</div>`;
                    runMatchingBtn.disabled = false;
                    runMatchingBtn.classList.remove('opacity-50');
                } else {
                    // Hide status message if no job is running or completed
                    taskStatus.classList.add('hidden');
                    runMatchingBtn.disabled = false;
                    runMatchingBtn.classList.remove('opacity-50');
                }
            })
            .catch(error => {
                console.error('Error updating jobs table:', error);
            });
    }

    // Initial jobs table update
    updateJobsTable();

    matchingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(matchingForm);
        
        // Show loading state
        taskStatus.classList.remove('hidden');
        runMatchingBtn.disabled = true;
        runMatchingBtn.classList.add('opacity-50');
        
        // Submit the form
        fetch(matchingForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrf_token')
            }
        })
        .then(response => {
            if (response.ok) {
                // Start polling for status
                statusCheckInterval = setInterval(updateJobsTable, 2000);
            } else {
                throw new Error('Failed to start task');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            taskStatus.innerHTML = '<div class="text-red-600">Error starting task. Please try again.</div>';
            runMatchingBtn.disabled = false;
            runMatchingBtn.classList.remove('opacity-50');
        });
    });

    // Add delete site functionality
    window.deleteSite = function(siteId) {
        if (confirm('Are you sure you want to delete this site? This action cannot be undone.')) {
            fetch(`{{ url_for('content_gaps.delete_site', project_id=project_id) }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ site_id: siteId })
            })
            .then(response => {
                if (response.ok) {
                    // Reload the page to reflect changes
                    window.location.reload();
                } else {
                    throw new Error('Failed to delete site');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete site. Please try again.');
            });
        }
    };
});
</script>
{% endblock %} 