{% extends "base.html" %}

{% block title %}Processing Content Plan{% endblock %}

{% block head %}
<style>
    .progress-container {
        width: 100%;
        background-color: #EFF6FF;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .progress-bar {
        height: 16px;
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        transition: width 0.3s ease;
    }
    .loading-spinner {
        border: 4px solid rgba(219, 234, 254, 0.3);
        border-radius: 50%;
        border-top: 4px solid #3B82F6;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-secondary-800 mb-3">Creating Your Content Plan</h1>
        <p class="text-lg text-secondary-600">Please wait while we research and generate your content plan</p>
    </header>
    
    <div class="card p-8">
        <div class="mb-8 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 id="status-message" class="text-xl font-semibold text-secondary-800 mb-2">Initializing...</h2>
            <p id="status-details" class="text-secondary-600">Starting the content research process</p>
        </div>
        
        <div class="progress-container mb-6">
            <div id="progress-bar" class="progress-bar" style="width: 5%;"></div>
        </div>
        
        <div class="text-secondary-500 text-sm">
            <p>This typically takes 1-2 minutes. Please don't close this window.</p>
        </div>
    </div>
    
    <div class="mt-6 text-center text-secondary-500 text-sm">
        <p>Your content plan is being created with these details:</p>
        <p><strong>Topic:</strong> {{ request_data.topic }}</p>
        <p><strong>Audience:</strong> {{ request_data.audience }}</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = "{{ job_id }}";
        const statusMessage = document.getElementById('status-message');
        const statusDetails = document.getElementById('status-details');
        const progressBar = document.getElementById('progress-bar');
        
        let checkInterval;
        
        function checkStatus() {
            fetch(`/apps/content-plan/job-status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    // Update status message
                    statusMessage.textContent = data.stage_description;
                    statusDetails.textContent = data.status_message;
                    
                    // Update progress bar
                    progressBar.style.width = data.progress + '%';
                    
                    // If complete, redirect to results
                    if (data.status === 'completed') {
                        window.location.href = `/apps/content-plan/results/${jobId}`;
                        clearInterval(checkInterval);
                    } else if (data.status === 'failed') {
                        statusMessage.textContent = 'Error Occurred';
                        statusDetails.textContent = 'There was a problem generating your content plan. Please try again.';
                        statusMessage.classList.add('text-red-600');
                        clearInterval(checkInterval);
                    }
                })
                .catch(error => {
                    console.error('Error checking job status:', error);
                });
        }
        
        // Check status immediately and then every 2 seconds
        checkStatus();
        checkInterval = setInterval(checkStatus, 2000);
    });
</script>
{% endblock %}