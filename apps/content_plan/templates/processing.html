{% extends "base.html" %}

{% block title %}Processing Content Plan{% endblock %}

{% block head %}
<style>
    .progress-container {
        width: 100%;
        background-color: #EFF6FF;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .progress-bar {
        height: 16px;
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        transition: width 0.3s ease;
    }
    .loading-spinner {
        border: 4px solid rgba(219, 234, 254, 0.3);
        border-radius: 50%;
        border-top: 4px solid #3B82F6;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .theme-card {
        border: 2px solid #E5E7EB;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .theme-card:hover {
        border-color: #3B82F6;
        transform: translateY(-2px);
    }
    .theme-card.selected {
        border-color: #3B82F6;
        background-color: #EFF6FF;
    }
    .theme-title {
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }
    .theme-description {
        color: #4B5563;
        font-size: 0.875rem;
    }
    .theme-selection-container {
        display: none;
        margin-top: 2rem;
    }
    .theme-selection-container.visible {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-secondary-800 mb-3">Creating Your Content Plan</h1>
        <p class="text-lg text-secondary-600">Please wait while we research and generate your content plan</p>
    </header>
    
    <div class="card p-8">
        <div class="mb-8 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 id="status-message" class="text-xl font-semibold text-secondary-800 mb-2">Initializing...</h2>
            <p id="status-details" class="text-secondary-600">Starting the content research process</p>
        </div>
        
        <div class="progress-container mb-6">
            <div id="progress-bar" class="progress-bar" style="width: 5%;"></div>
        </div>
        
        <div class="text-secondary-500 text-sm">
            <p>This typically takes 1-2 minutes. Please don't close this window.</p>
        </div>
    </div>

    <!-- Theme Selection UI -->
    <div id="theme-selection" class="theme-selection-container">
        <div class="card p-8">
            <h2 class="text-xl font-semibold text-secondary-800 mb-4">Select a Theme</h2>
            <p class="text-secondary-600 mb-6">Please select one of the following themes to continue with your content plan:</p>
            <div id="themes-container"></div>
            <div class="mt-6 text-center">
                <button id="submit-theme" class="btn btn-primary" disabled>Continue with Selected Theme</button>
            </div>
        </div>
    </div>
    
    <div class="mt-6 text-center text-secondary-500 text-sm">
        <p>Your content plan is being created with:</p>
        <p><strong>Website URL:</strong> {{ job.website_url }}</p>
        <p><strong>Keywords:</strong> {{ job.keywords|join(', ') }}</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = "{{ job_id }}";
        const statusMessage = document.getElementById('status-message');
        const statusDetails = document.getElementById('status-details');
        const progressBar = document.getElementById('progress-bar');
        const themeSelection = document.getElementById('theme-selection');
        const themesContainer = document.getElementById('themes-container');
        const submitThemeBtn = document.getElementById('submit-theme');
        
        let checkInterval;
        let selectedThemeId = null;
        
        function checkStatus() {
            fetch(`/apps/content-plan/job-status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    // Update status message
                    statusMessage.textContent = data.current_phase || 'Processing...';
                    statusDetails.textContent = data.messages && data.messages.length > 0 
                        ? data.messages[data.messages.length - 1].text || data.messages[data.messages.length - 1]
                        : 'Working on your content plan...';
                    
                    // Update progress bar
                    progressBar.style.width = data.progress + '%';
                    
                    // Handle themes if available
                    if (data.themes && data.themes.length > 0) {
                        // Show theme selection UI
                        themeSelection.classList.add('visible');
                        document.querySelector('.loading-spinner').style.display = 'none';
                        
                        // Populate themes
                        themesContainer.innerHTML = data.themes.map(theme => `
                            <div class="theme-card ${selectedThemeId === theme.id ? 'selected' : ''}" 
                                 onclick="selectTheme('${theme.id}')">
                                <div class="theme-title">${theme.title}</div>
                                <div class="theme-description">${theme.description}</div>
                            </div>
                        `).join('');
                    }
                    
                    // If complete, redirect to results
                    if (data.status === 'completed') {
                        window.location.href = `/apps/content-plan/results/${jobId}`;
                        clearInterval(checkInterval);
                    } else if (data.status === 'failed' || data.status === 'error') {
                        statusMessage.textContent = 'Error Occurred';
                        statusDetails.textContent = data.error || 'There was a problem generating your content plan. Please try again.';
                        statusMessage.classList.add('text-red-600');
                        clearInterval(checkInterval);
                    }
                })
                .catch(error => {
                    console.error('Error checking job status:', error);
                });
        }
        
        // Function to select a theme
        window.selectTheme = function(themeId) {
            selectedThemeId = themeId;
            
            // Update UI to show selected theme
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.toggle('selected', card.getAttribute('onclick').includes(themeId));
            });
            
            // Enable submit button
            submitThemeBtn.disabled = false;
        };
        
        // Handle theme submission
        submitThemeBtn.addEventListener('click', function() {
            if (!selectedThemeId) return;
            
            // Disable button to prevent double submission
            submitThemeBtn.disabled = true;
            submitThemeBtn.textContent = 'Processing...';
            
            // Submit theme selection
            fetch(`/apps/content-plan/api/theme-selection/${jobId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ theme_number: selectedThemeId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide theme selection and show loading spinner
                    themeSelection.classList.remove('visible');
                    document.querySelector('.loading-spinner').style.display = 'block';
                    statusMessage.textContent = 'Processing selected theme...';
                } else {
                    throw new Error(data.error || 'Failed to submit theme selection');
                }
            })
            .catch(error => {
                console.error('Error submitting theme:', error);
                submitThemeBtn.disabled = false;
                submitThemeBtn.textContent = 'Continue with Selected Theme';
                alert('Failed to submit theme selection. Please try again.');
            });
        });
        
        // Check status immediately and then every 2 seconds
        checkStatus();
        checkInterval = setInterval(checkStatus, 2000);
    });
</script>
{% endblock %}