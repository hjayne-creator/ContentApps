{% extends "base.html" %}

{% block title %}Processing Content Plan{% endblock %}

{% block head %}
<style>
    .progress-container {
        width: 100%;
        background-color: #EFF6FF;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .progress-bar {
        height: 16px;
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        transition: width 0.3s ease;
    }
    .loading-spinner {
        border: 4px solid rgba(219, 234, 254, 0.3);
        border-radius: 50%;
        border-top: 4px solid #3B82F6;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .theme-card {
        border: 2px solid #E5E7EB;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .theme-card:hover {
        border-color: #3B82F6;
        transform: translateY(-2px);
    }
    .theme-card.selected {
        border-color: #3B82F6;
        background-color: #EFF6FF;
    }
    .theme-card.processing {
        opacity: 0.7;
        cursor: not-allowed;
    }
    .theme-title {
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }
    .theme-description {
        color: #4B5563;
        font-size: 0.875rem;
    }
    .theme-selection-container {
        display: none;
        margin-top: 2rem;
    }
    .theme-selection-container.visible {
        display: block;
    }
    .theme-form {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-secondary-800 mb-3">Creating Your Content Plan</h1>
        <p class="text-lg text-secondary-600">Please wait while we research and generate your content plan</p>
    </header>
    
    <div class="card p-8">
        <div class="mb-8 text-center">
            <div class="loading-spinner mb-4"></div>
            <h2 id="status-message" class="text-xl font-semibold text-secondary-800 mb-2">Initializing...</h2>
            <p id="status-details" class="text-secondary-600">Starting the content research process</p>
        </div>
        
        <div class="progress-container mb-6">
            <div id="progress-bar" class="progress-bar" style="width: 5%;"></div>
        </div>
        
        <div class="text-secondary-500 text-sm">
            <p>This typically takes 1-2 minutes. Please don't close this window.</p>
        </div>
    </div>

    <!-- Theme Selection UI -->
    <div id="theme-selection" class="theme-selection-container">
        <div class="card p-8">
            <h2 class="text-xl font-semibold text-secondary-800 mb-4">Select a Theme</h2>
            <p class="text-secondary-600 mb-6">Click on a theme to continue with your content plan:</p>
            <div id="themes-container"></div>
        </div>
    </div>
    
    <!-- Hidden form for fallback submission -->
    <form id="theme-form" class="theme-form" method="POST">
        <input type="hidden" name="theme_number" id="theme-input">
    </form>
    
    <div class="mt-6 text-center text-secondary-500 text-sm">
        <p>Your content plan is being created with:</p>
        <p><strong>Website URL:</strong> {{ job.website_url }}</p>
        <p><strong>Keywords:</strong> {{ job.keywords|join(', ') }}</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = "{{ job_id }}";
        const statusMessage = document.getElementById('status-message');
        const statusDetails = document.getElementById('status-details');
        const progressBar = document.getElementById('progress-bar');
        const themeSelection = document.getElementById('theme-selection');
        const themesContainer = document.getElementById('themes-container');
        const themeForm = document.getElementById('theme-form');
        const themeInput = document.getElementById('theme-input');
        
        let checkInterval;
        let isSubmitting = false;
        let xhrAttemptFailed = false;
        
        // Function to ensure URL has proper leading slash
        function formatURL(url) {
            return url.startsWith('/') ? url : '/' + url;
        }

        function checkStatus() {
            let statusUrl, resultsPath;
            
            try {
                // Get the current location path and construct the API URL
                const pathParts = window.location.pathname.split('/');
                const processIndex = pathParts.indexOf('process');
                
                if (processIndex !== -1) {
                    // Normal path construction
                    const basePath = pathParts.slice(0, processIndex + 1).join('/');
                    const statusPath = formatURL(basePath.replace('/process', '/job-status'));
                    resultsPath = formatURL(basePath.replace('/process', '/results'));
                    statusUrl = `${statusPath}/${jobId}`;
                } else {
                    // Fallback for when 'process' is not in the path
                    console.log("Process not found in path, using default URLs");
                    statusUrl = formatURL(`/apps/content-plan/job-status/${jobId}`);
                    resultsPath = formatURL(`/apps/content-plan/results`);
                }
            } catch (error) {
                // Ultimate fallback
                console.error("Error constructing API URLs:", error);
                statusUrl = formatURL(`/apps/content-plan/job-status/${jobId}`);
                resultsPath = formatURL(`/apps/content-plan/results`);
            }
            
            console.log(`Status URL: ${statusUrl}`);
            
            fetch(statusUrl)
                .then(response => response.json())
                .then(data => {
                    // Update status message
                    statusMessage.textContent = data.current_phase || 'Processing...';
                    statusDetails.textContent = data.messages && data.messages.length > 0 
                        ? data.messages[data.messages.length - 1].text || data.messages[data.messages.length - 1]
                        : 'Working on your content plan...';
                    
                    // Update progress bar
                    progressBar.style.width = data.progress + '%';
                    
                    // Handle themes if available
                    if (data.themes && data.themes.length > 0 && !isSubmitting) {
                        // Show theme selection UI
                        themeSelection.classList.add('visible');
                        document.querySelector('.loading-spinner').style.display = 'none';
                        
                        // Populate themes
                        themesContainer.innerHTML = data.themes.map((theme, index) => `
                            <div class="theme-card" 
                                 onclick="selectTheme(${index + 1})">
                                <div class="theme-title">${theme.title}</div>
                                <div class="theme-description">${theme.description}</div>
                            </div>
                        `).join('');
                    }
                    
                    // If complete, redirect to results
                    if (data.status === 'completed') {
                        window.location.href = `${resultsPath}/${jobId}`;
                        clearInterval(checkInterval);
                    } else if (data.status === 'failed' || data.status === 'error') {
                        statusMessage.textContent = 'Error Occurred';
                        statusDetails.textContent = data.error || 'There was a problem generating your content plan. Please try again.';
                        statusMessage.classList.add('text-red-600');
                        clearInterval(checkInterval);
                    }
                })
                .catch(error => {
                    console.error('Error checking job status:', error);
                });
        }
        
        // Function to select and submit a theme
        window.selectTheme = function(themeId) {
            if (isSubmitting) return;
            
            isSubmitting = true;
            
            // Update UI to show selected theme and processing state
            document.querySelectorAll('.theme-card').forEach(card => {
                if (card.getAttribute('onclick').includes(themeId)) {
                    card.classList.add('selected', 'processing');
                } else {
                    card.classList.add('processing');
                }
            });
            
            // Show loading spinner and update status
            document.querySelector('.loading-spinner').style.display = 'block';
            statusMessage.textContent = 'Processing selected theme...';
            
            // Ensure themeId is a string with digits only
            const themeIdStr = String(parseInt(themeId));
            
            // If previous XHR attempt failed, use form submission directly
            if (xhrAttemptFailed) {
                submitWithForm(themeIdStr);
                return;
            }
            
            let requestUrl;
            
            try {
                // Get the current location path and construct the API URL
                const pathParts = window.location.pathname.split('/');
                const processIndex = pathParts.indexOf('process');
                
                if (processIndex !== -1) {
                    // Normal path construction
                    const basePath = pathParts.slice(0, processIndex + 1).join('/');
                    const apiPath = formatURL(basePath.replace('/process', '/api/theme-selection'));
                    requestUrl = `${apiPath}/${jobId}`;
                } else {
                    // Fallback for when 'process' is not in the path
                    console.log("Process not found in path, using default URL");
                    requestUrl = formatURL(`/apps/content-plan/api/theme-selection/${jobId}`);
                }
            } catch (error) {
                // Ultimate fallback
                console.error("Error constructing API URL:", error);
                requestUrl = formatURL(`/apps/content-plan/api/theme-selection/${jobId}`);
            }
            
            const requestBody = { theme_number: themeIdStr };
            
            console.log(`Submitting theme selection: ${themeIdStr} for job ${jobId}`);
            console.log(`Request URL: ${requestUrl}`);
            console.log(`Request body:`, requestBody);
            
            // Create a new XMLHttpRequest to handle the request directly
            const xhr = new XMLHttpRequest();
            xhr.open('POST', requestUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.withCredentials = true;  // Include credentials for cross-domain requests
            
            xhr.onload = function() {
                console.log(`Response status: ${xhr.status}`);
                console.log(`Response headers: ${xhr.getAllResponseHeaders()}`);
                console.log(`Response body: ${xhr.responseText}`);
                
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        console.log('Theme selection successful:', data);
                        
                        // Hide theme selection and update UI
                        themeSelection.classList.remove('visible');
                        statusMessage.textContent = 'Processing selected theme...';
                        
                        // Make sure we continue checking status
                        if (!checkInterval) {
                            checkInterval = setInterval(checkStatus, 2000);
                        }
                    } catch (e) {
                        console.error('Error parsing JSON response:', e);
                        handleThemeSelectionError('Invalid JSON response from server');
                    }
                } else {
                    console.error('Error response:', xhr.responseText);
                    xhrAttemptFailed = true;
                    
                    // Try form submission approach as fallback
                    submitWithForm(themeIdStr);
                }
            };
            
            xhr.onerror = function() {
                console.error('Network error occurred');
                xhrAttemptFailed = true;
                
                // Try form submission approach as fallback
                submitWithForm(themeIdStr);
            };
            
            // Helper function for form submission
            function submitWithForm(themeNum) {
                console.log('Trying form submission as fallback');
                
                // Set up the form
                themeInput.value = themeNum;
                themeForm.action = requestUrl;
                
                // Submit the form
                themeForm.submit();
            }
            
            // Helper function to handle errors
            function handleThemeSelectionError(message) {
                console.error(message);
                
                // If this is our first XHR error, try form submission
                if (!xhrAttemptFailed) {
                    xhrAttemptFailed = true;
                    submitWithForm(themeIdStr);
                    return;
                }
                
                isSubmitting = false;
                // Reset UI state
                document.querySelectorAll('.theme-card').forEach(card => {
                    card.classList.remove('selected', 'processing');
                });
                document.querySelector('.loading-spinner').style.display = 'none';
                themeSelection.classList.add('visible');
                alert(`Failed to submit theme selection: ${message}`);
            }
            
            // Send the request
            xhr.send(JSON.stringify(requestBody));
        };
        
        // Check status immediately and then every 2 seconds
        checkStatus();
        checkInterval = setInterval(checkStatus, 2000);
    });
</script>
{% endblock %}